<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ğŸµ é»æ­Œç³»çµ±</title>
    <script>
        async function searchSpotify() {
            const keyword = document.getElementById("title").value;
            if (!keyword) return;
            const res = await fetch(`/spotify?q=${encodeURIComponent(keyword)}`);
            const data = await res.json();
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "";
            data.tracks.forEach(track => {
                const btn = document.createElement("button");
                btn.innerText = `${track.name} - ${track.artist}`;
                btn.onclick = () => {
                    document.getElementById("title").value = track.name;
                    document.getElementById("spotify_url").value = track.url;
                };
                resultsDiv.appendChild(btn);
            });
        }

        async function submitForm() {
            const payload = {
                name: document.getElementById("name").value,
                gender: document.getElementById("gender").value,
                title: document.getElementById("title").value,
                spotify_url: document.getElementById("spotify_url").value
            };
            const res = await fetch("/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            alert(result.status === "success" ? "âœ… é»æ­ŒæˆåŠŸï¼" : result.status);
        }

        async function exportData() {
            const res = await fetch("/export", { method: "POST" });
            const result = await res.json();
            alert(result.status);
        }
    </script>
</head>
<body>
    <h2>ğŸ¤ é»æ­Œè¡¨å–®</h2>

    {% if form_open %}
        å§“åï¼š<input id="name"><br>
        æ€§åˆ¥ï¼š
        <select id="gender">
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
        </select><br>
        æ­Œåï¼š<input id="title" oninput="searchSpotify()"><br>
        <input type="hidden" id="spotify_url">
        <div id="results"></div><br>
        <button onclick="submitForm()">é€å‡º</button>
    {% else %}
        <p>âš ï¸ è¡¨å–®å·²é—œé–‰ï¼Œè«‹æ–¼æŒ‡å®šæ™‚é–“å…§å¡«å¯«ã€‚</p>
    {% endif %}

    <hr>
    <button onclick="exportData()">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
</body>
</html>